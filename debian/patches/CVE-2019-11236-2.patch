Backport of:

From efddd7e7bad26188c3b692d1090cba768afa9162 Mon Sep 17 00:00:00 2001
From: Ryan Petrello <lists@ryanpetrello.com>
Date: Thu, 2 May 2019 11:03:09 -0400
Subject: [PATCH] Avoid CVE-2019-9740 in 1.24.x by percent-encoding invalid
 target characters (#1593)

---
 src/urllib3/util/url.py |  4 ++--
 test/test_util.py       | 22 +++++++++++++++++++---
 2 files changed, 21 insertions(+), 5 deletions(-)

Index: python-urllib3-1.13.1/urllib3/util/url.py
===================================================================
--- python-urllib3-1.13.1.orig/urllib3/util/url.py	2019-05-14 09:00:24.999214311 -0400
+++ python-urllib3-1.13.1/urllib3/util/url.py	2019-05-14 09:00:24.999214311 -0400
@@ -3,6 +3,7 @@ from collections import namedtuple
 import re
 
 from ..exceptions import LocationParseError
+from ..packages.six.moves.urllib.parse import quote
 
 
 url_attrs = ['scheme', 'auth', 'host', 'port', 'path', 'query', 'fragment']
@@ -151,8 +152,7 @@ def parse_url(url):
 
     # Prevent CVE-2019-9740.
     # adapted from https://github.com/python/cpython/pull/12755
-    if _contains_disallowed_url_pchar_re.search(url):
-        raise LocationParseError("URL can't contain control characters. {!r}".format(url))
+    url = _contains_disallowed_url_pchar_re.sub(lambda match: quote(match.group()), url)
 
     scheme = None
     auth = None
Index: python-urllib3-1.13.1/test/test_util.py
===================================================================
--- python-urllib3-1.13.1.orig/test/test_util.py	2019-05-14 09:00:24.999214311 -0400
+++ python-urllib3-1.13.1/test/test_util.py	2019-05-14 09:05:20.889579775 -0400
@@ -149,9 +149,22 @@ class TestUtil(unittest.TestCase):
     def test_parse_url_invalid_IPv6(self):
         self.assertRaises(ValueError, parse_url, '[::1')
 
-    def test_parse_url_contains_control_characters(self):
+    def test_parse_url_contains_control_characters_1(self):
         # see CVE-2019-9740
-        self.assertRaises(LocationParseError, parse_url, 'http://localhost:8000/ HTTP/1.1\r\nHEADER: INJECTED\r\nIgnore:')
+        url = parse_url('http://localhost/ HTTP/1.1\r\nHEADER: INJECTED\r\nIgnore:')
+        assert url == Url('http', host='localhost', port=None,
+                          path='/%20HTTP/1.1%0D%0AHEADER:%20INJECTED%0D%0AIgnore:')
+
+    def test_parse_url_contains_control_characters_2(self):
+        # see CVE-2019-9740
+        url = parse_url(u'http://localhost/ HTTP/1.1\r\nHEADER: INJECTED\r\nIgnore:')
+        assert url == Url('http', host='localhost', port=None,
+                          path='/%20HTTP/1.1%0D%0AHEADER:%20INJECTED%0D%0AIgnore:')
+
+    def test_parse_url_contains_control_characters_3(self):
+        # see CVE-2019-9740
+        url = parse_url('http://localhost/ ?q=\r\n')
+        assert url == Url('http', host='localhost', path='/%20', query='q=%0D%0A')
 
     def test_Url_str(self):
         U = Url('http', host='google.com')
